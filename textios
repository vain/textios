#!/bin/bash

if [[ ! -f ~/.textiosrc ]]
then
	echo 'Cannot read ~/.textiosrc' >&2
	exit 1
fi

. ~/.textiosrc

filters='CRITICAL,UNKNOWN'
onlyhosts=0
softstates=0
while getopts awhs name
do
	case $name in
		a)
			filters=
			;;
		w)
			filters='WARNING,CRITICAL,UNKNOWN'
			;;
		h)
			onlyhosts=1
			;;
		s)
			softstates=1
			;;
	esac
done
shift $((OPTIND - 1))
labels=" $1 "

rm -f /tmp/textios-*

for (( i = 0; i < "${#monitors[@]}"; i += 4 ))
do
	[[ "$labels" != "  " ]] && \
		[[ "${labels// ${monitors[$i]} }" == "$labels" ]] && continue
	printf -v suff '%02d-%s' "$i" "${monitors[$i]}"
	echo "Fetching $suff..."
	case ${monitors[$((i + 1))]} in
		icinga)
			(
				curl --fail --compressed -nsLk "${monitors[$((i + 2))]}" |
					sed 1d | textios-csv_to_editable "$filters" "$softstates" |
					{ (( onlyhosts )) && textios-onlyhosts || cat; } \
					>/tmp/textios-"$suff"
				ret=${PIPESTATUS[0]}
				(( ret != 0 )) && echo "$suff failed, curl error $ret" >&2
			) &
			;;
		nagios)
			(
				curl --fail --compressed -nsLk "${monitors[$((i + 2))]}" |
					textios-nagios_to_csv |
					sed 1d | textios-csv_to_editable "$filters" "$softstates" |
					{ (( onlyhosts )) && textios-onlyhosts || cat; } \
					>/tmp/textios-"$suff"
				ret=${PIPESTATUS[0]}
				(( ret != 0 )) && echo "$suff failed, curl error $ret" >&2
			) &
			;;
	esac
done

wait
vim -o /tmp/textios-*

for (( i = 0; i < "${#monitors[@]}"; i += 4 ))
do
	[[ "$labels" != "  " ]] && \
		[[ "${labels// ${monitors[$i]} }" == "$labels" ]] && continue
	printf -v suff '%02d-%s' "$i" "${monitors[$i]}"
	echo "Processing $suff..."
	textios-process_editable "${monitors[$((i + 3))]}" \
		</tmp/textios-"$suff"
done
